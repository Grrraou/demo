services:
  app:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    volumes:
      - .:/var/www/html
    environment:
      - APP_ENV=local
      - DB_HOST=postgres
      - REDIS_HOST=redis
    depends_on:
      - postgres
      - redis
    networks:
      - erp

  nginx:
    image: nginx:alpine
    ports:
      - "${APP_PORT:-8080}:80"
    volumes:
      - .:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - app
    networks:
      - erp

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${DB_DATABASE:-erp}
      POSTGRES_USER: ${DB_USERNAME:-erp}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secret}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - erp

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - erp

  reverb:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    command: php artisan reverb:start --host=0.0.0.0 --port=8080 --debug
    volumes:
      - .:/var/www/html
    environment:
      - APP_ENV=local
      - DB_HOST=postgres
      - REDIS_HOST=redis
      - REVERB_HOST=0.0.0.0
      - REVERB_PORT=8080
    ports:
      - "${REVERB_PORT:-8085}:8080"
    depends_on:
      - redis
    networks:
      - erp

  queue:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    command: php artisan queue:work redis --sleep=3 --tries=3 --max-time=3600
    volumes:
      - .:/var/www/html
    environment:
      - APP_ENV=local
      - DB_HOST=postgres
      - REDIS_HOST=redis
    depends_on:
      - postgres
      - redis
    networks:
      - erp

  pgadmin:
    build:
      context: .
      dockerfile: docker/pgadmin/Dockerfile
    image: demo-pgadmin:latest
    profiles:
      - pgadmin
    restart: on-failure
    environment:
      PGADMIN_LISTEN_ADDRESS: 0.0.0.0
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
      PGADMIN_SERVER_JSON_FILE: /pgadmin4/servers.json
      PGADMIN_REPLACE_SERVERS_ON_STARTUP: "True"
      PGPASSFILE: /tmp/pgpass
      PGPASSWORD: ${DB_PASSWORD:-secret}
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-erp}
      DB_USERNAME: ${DB_USERNAME:-erp}
      DB_PASSWORD: ${DB_PASSWORD:-secret}
    ports:
      - "0.0.0.0:${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./docker/pgadmin/servers.json:/pgadmin4/servers.json:ro
    depends_on:
      - postgres
    networks:
      - erp

  # Jitsi Meet - Self-hosted video conferencing
  jitsi-web:
    image: jitsi/web:stable-9584
    restart: unless-stopped
    ports:
      - "${JITSI_PORT:-8443}:80"
    volumes:
      - ${JITSI_CONFIG:-./docker/jitsi}/web:/config:Z
      - ${JITSI_CONFIG:-./docker/jitsi}/transcripts:/usr/share/jitsi-meet/transcripts:Z
      - ./docker/jitsi/web/custom-config.js:/usr/share/jitsi-meet/custom-config.js:ro
      - ./docker/jitsi/web/custom-interface_config.js:/usr/share/jitsi-meet/custom-interface_config.js:ro
    environment:
      - PUBLIC_URL=${JITSI_PUBLIC_URL:-http://localhost:8443}
      - TZ=${TZ:-UTC}
      - ENABLE_AUTH=0
      - ENABLE_GUESTS=1
      - ENABLE_LOBBY=0
      - ENABLE_PREJOIN_PAGE=0
      - ENABLE_WELCOME_PAGE=0
      - ENABLE_CLOSE_PAGE=0
      - DISABLE_HTTPS=1
      - ENABLE_XMPP_WEBSOCKET=1
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD:-jicofopass}
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD:-jvbpass}
      - JIGASI_XMPP_PASSWORD=${JIGASI_XMPP_PASSWORD:-jigasipass}
      - JIBRI_RECORDER_PASSWORD=${JIBRI_RECORDER_PASSWORD:-jibrirecorderpass}
      - JIBRI_XMPP_PASSWORD=${JIBRI_XMPP_PASSWORD:-jibrixmpppass}
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_SERVER=prosody
      - XMPP_BOSH_URL_BASE=http://prosody:5280
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_GUEST_DOMAIN=guest.meet.jitsi
    depends_on:
      - prosody
    networks:
      erp:
        aliases:
          - meet.jitsi

  prosody:
    image: jitsi/prosody:stable-9584
    restart: unless-stopped
    expose:
      - "5222"
      - "5280"
      - "5347"
    volumes:
      - ${JITSI_CONFIG:-./docker/jitsi}/prosody/config:/config:Z
      - ${JITSI_CONFIG:-./docker/jitsi}/prosody/prosody-plugins-custom:/prosody-plugins-custom:Z
    environment:
      - TZ=${TZ:-UTC}
      - ENABLE_AUTH=0
      - ENABLE_GUESTS=1
      - ENABLE_LOBBY=0
      - ENABLE_XMPP_WEBSOCKET=1
      - GLOBAL_MODULES=
      - GLOBAL_CONFIG=
      - LDAP_URL=
      - LDAP_BASE=
      - LDAP_BINDDN=
      - LDAP_BINDPW=
      - LDAP_FILTER=
      - LDAP_AUTH_METHOD=
      - LDAP_VERSION=
      - LDAP_USE_TLS=
      - LDAP_TLS_CIPHERS=
      - LDAP_TLS_CHECK_PEER=
      - LDAP_TLS_CACERT_FILE=
      - LDAP_TLS_CACERT_DIR=
      - LDAP_START_TLS=
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_SERVER=prosody
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_GUEST_DOMAIN=guest.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_MODULES=
      - XMPP_MUC_MODULES=
      - XMPP_INTERNAL_MUC_MODULES=
      - XMPP_RECORDER_DOMAIN=recorder.meet.jitsi
      - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET:-s3cr3t}
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD:-jicofopass}
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD:-jvbpass}
      - JIGASI_XMPP_PASSWORD=${JIGASI_XMPP_PASSWORD:-jigasipass}
      - JIBRI_RECORDER_PASSWORD=${JIBRI_RECORDER_PASSWORD:-jibrirecorderpass}
      - JIBRI_XMPP_PASSWORD=${JIBRI_XMPP_PASSWORD:-jibrixmpppass}
      - LOG_LEVEL=info
    networks:
      erp:
        aliases:
          - prosody
          - xmpp.meet.jitsi

  jicofo:
    image: jitsi/jicofo:stable-9584
    restart: unless-stopped
    volumes:
      - ${JITSI_CONFIG:-./docker/jitsi}/jicofo:/config:Z
    environment:
      - TZ=${TZ:-UTC}
      - ENABLE_AUTH=0
      - ENABLE_LOBBY=0
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_SERVER=prosody
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET:-s3cr3t}
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD:-jicofopass}
      - JVB_BREWERY_MUC=jvbbrewery
      - JIGASI_BREWERY_MUC=jigasibrewery
      - JIBRI_BREWERY_MUC=jibribrewery
      - JIBRI_PENDING_TIMEOUT=90
    depends_on:
      - prosody
    networks:
      - erp

  jvb:
    image: jitsi/jvb:stable-9584
    restart: unless-stopped
    ports:
      - "${JVB_PORT:-10000}:10000/udp"
    volumes:
      - ${JITSI_CONFIG:-./docker/jitsi}/jvb:/config:Z
    environment:
      - TZ=${TZ:-UTC}
      - XMPP_SERVER=prosody
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD:-jvbpass}
      - JVB_BREWERY_MUC=jvbbrewery
      - JVB_PORT=${JVB_PORT:-10000}
      - JVB_STUN_SERVERS=meet-jit-si-turnrelay.jitsi.net:443
      - PUBLIC_URL=${JITSI_PUBLIC_URL:-http://localhost:8443}
    depends_on:
      - prosody
    networks:
      - erp

volumes:
  postgres_data:
  redis_data:
  pgadmin_data:
  jitsi_web_config:
  jitsi_prosody_config:
  jitsi_jicofo_config:
  jitsi_jvb_config:

networks:
  erp:
    driver: bridge
